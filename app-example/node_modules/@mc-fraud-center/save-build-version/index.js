#!/usr/bin/env node
'use strict';

var fs = require('fs');
var xml2js = require('xml2js');

var exitCode = 1;
var cwd = process.cwd();

// parse pom.xml
var parser = new xml2js.Parser();
fs.readFile(cwd + '/pom.xml', function(err, data) {
  parser.parseString(data, function (err, result) {
    var pomInfo = `${result.project.artifactId}@${result.project.version}`;
    
    // parse package.json
    var pkg = require(cwd + '/package.json');
    var npmInfo = `${pkg.name}@${pkg.version}`;
    
    // output result
    var buildDate = `Build date: ${new Date()}`;
    var html = `<!--\n${pomInfo}\n${buildDate}\n-->`;
    fs.appendFile(cwd + '/dist/index.html', html, function(err) {
      if(err) {
        console.error(err);
      } else {
        if (pomInfo === npmInfo) {
          console.info(`${pomInfo}\n${buildDate}`);
          exitCode = 0;
        } else {
          console.error(`Mismatch!\nPOM: ${pomInfo}\nNPM: ${npmInfo}\n${buildDate}`);
        }
      }

      process.exit(exitCode);

    });    
  });
});
